import subprocess
import json
import numpy as np
import matplotlib.pyplot as plt
from fit_model import fit, func

cpus = {
    "1": "0",
    "2": "0,1",
    "3": "0,1,2",
    "5": "0,1,2,3,4",
    "7": "0,1,2,3,4,5,6",
    "9": "0,1,2,3,4,5,6,7,8",
    "11": "0,1,2,3,4,5,6,7,8,9,10",
    "13": "0,1,2,3,4,5,6,7,8,9,10,11,12"
}

#p = subprocess.Popen(["taskset", "-c", cpus["3"], "python3", "server_cpu_test.py"])
#p.wait()


# plt.plot([1, 3, 5, 7, 9, 11], [590.6,  215.2, 135.5,  104.6,  96.5, 96.5])
# plt.show()


# [1,  3, 5, 7, 9, 11]
# [48.7, 26.5,  18.7,  12.6,   11.4,   11.2, 11.0]   alex
# [590.6,  215.2, 135.5,  104.6,  96.5, 96.5]   vgg
# [89.5,   42.0,  29.5,   26.2]   restnet


# restnet
"""
t_layer_1 = [4.5939, 2.9671, 5.6527, 4.1479, 0.9809, 4.045, 0.8943, 4.0908, 0.9619, 4.0945, 0.8743, 2.3069, 0.6835, 3.9638, 0.6315, 3.9431, 0.6787, 3.939, 0.6256, 2.3225, 0.5636, 4.1225, 0.5301, 4.0849, 0.5794, 4.0784, 0.5471, 3.0307, 0.6463, 5.6914, 0.6242, 5.587, 0.6541, 5.6037, 0.625, 0.0819, 0.2834]
t_layer_2 = [2.5355, 1.741, 3.0375, 2.3099, 0.7183, 2.2251, 0.6401, 2.2004, 0.6923, 2.2104, 0.6293, 1.3201, 0.5403, 2.1494, 0.4956, 2.1507, 0.5404, 2.1491, 0.4997, 1.3582, 0.5709, 2.2601, 0.5384, 2.2054, 0.577, 2.2018, 0.543, 1.7838, 0.7709, 3.2021, 0.7543, 2.9649, 0.7893, 3.0171, 0.7593, 0.0835, 0.1934]
t_layer_3 = [1.8568, 1.4154, 2.2113, 1.6946, 0.6537, 1.622, 0.5725, 1.6219, 0.6083, 1.6028, 0.5483, 1.0001, 0.4905, 1.5611, 0.4467, 1.5452, 0.4902, 1.5561, 0.4534, 1.0273, 0.5615, 1.6713, 0.5276, 1.6223, 0.5678, 1.6296, 0.5269, 1.363, 0.7829, 2.4339, 0.7651, 2.2612, 0.8119, 2.2589, 0.785, 0.0827, 0.1632]
t_layer_5 = [1.2455, 1.0007, 1.4036, 1.1489, 0.4958, 1.0963, 0.4247, 1.084, 0.4553, 1.068, 0.4056, 0.7111, 0.3923, 1.0437, 0.3521, 1.0405, 0.3888, 1.0467, 0.3544, 0.7216, 0.4767, 1.1408, 0.4485, 1.1242, 0.4793, 1.1224, 0.4452, 0.9842, 0.686, 1.648, 0.6785, 1.5747, 0.7151, 1.5757, 0.6913, 0.0845, 0.1422]
t_layer_7 = [1.1043, 0.9701, 1.1564, 0.9859, 0.4559, 0.9038, 0.3857, 0.8956, 0.4196, 0.9034, 0.4049, 0.6563, 0.403, 0.8707, 0.3458, 0.8581, 0.382, 0.8657, 0.3476, 0.6257, 0.4918, 0.9509, 0.4449, 0.9234, 0.4654, 0.9391, 0.5172, 0.9628, 0.6776, 1.5108, 0.6812, 1.4007, 0.7206, 1.4003, 0.7073, 0.0881, 0.1645]

t_layer_1= [0.0147, 0.0095, 0.0181, 0.0133, 0.0031, 0.0129, 0.0029, 0.0131, 0.0031, 0.0131, 0.0028, 0.0074, 0.0022, 0.0127, 0.002, 0.0126, 0.0022, 0.0126, 0.002, 0.0074, 0.0018, 0.0132, 0.0017, 0.0131, 0.0019, 0.0131, 0.0018, 0.0097, 0.0021, 0.0182, 0.002, 0.0179, 0.0021, 0.0179, 0.002, 0.0003, 0.0009]
t_layer_2= [0.0162, 0.0111, 0.0194, 0.0148, 0.0046, 0.0142, 0.0041, 0.0141, 0.0044, 0.0141, 0.004, 0.0084, 0.0035, 0.0138, 0.0032, 0.0138, 0.0035, 0.0138, 0.0032, 0.0087, 0.0037, 0.0145, 0.0034, 0.0141, 0.0037, 0.0141, 0.0035, 0.0114, 0.0049, 0.0205, 0.0048, 0.019, 0.0051, 0.0193, 0.0049, 0.0005, 0.0012]
t_layer_3= [0.0119, 0.0091, 0.0142, 0.0108, 0.0042, 0.0104, 0.0037, 0.0104, 0.0039, 0.0103, 0.0035, 0.0064, 0.0031, 0.01, 0.0029, 0.0099, 0.0031, 0.01, 0.0029, 0.0066, 0.0036, 0.0107, 0.0034, 0.0104, 0.0036, 0.0104, 0.0034, 0.0087, 0.005, 0.0156, 0.0049, 0.0145, 0.0052, 0.0145, 0.005, 0.0005, 0.001]
t_layer_5= [0.008, 0.0064, 0.009, 0.0074, 0.0032, 0.007, 0.0027, 0.0069, 0.0029, 0.0068, 0.0026, 0.0046, 0.0025, 0.0067, 0.0023, 0.0067, 0.0025, 0.0067, 0.0023, 0.0046, 0.0031, 0.0073, 0.0029, 0.0072, 0.0031, 0.0072, 0.0028, 0.0063, 0.0044, 0.0105, 0.0043, 0.0101, 0.0046, 0.0101, 0.0044, 0.0005, 0.0009]
restnet_cx = [0.0127, 0.009, 0.0152, 0.0116, 0.0038, 0.0111, 0.0034, 0.0111, 0.0036, 0.0111, 0.0032, 0.0067, 0.0028, 0.0108, 0.0026, 0.0107, 0.0028, 0.0108, 0.0026, 0.0068, 0.0031, 0.0114, 0.0028, 0.0112, 0.0031, 0.0112, 0.0029, 0.009, 0.0041, 0.0162, 0.004, 0.0154, 0.0042, 0.0154, 0.0041, 0.0004, 0.001]
"""

# vgg
"""
t_layer_1 = [6.7142, 62.7045, 11.9939, 30.2226, 58.2168, 6.4216, 29.2068, 59.5509, 63.7077, 30.0318, 59.5694, 60.2691, 15.9463, 15.6861, 16.5236, 38.9661, 6.278, 1.5381]
t_layer_3 = [4.6016, 25.1781, 4.8691, 11.6683, 22.3522, 2.5995, 11.1685, 20.9353, 22.0757, 10.6582, 20.916, 21.8427, 6.0378, 5.9959, 6.3535, 16.3884, 2.8345, 0.7066]
t_layer_5 = [2.377, 15.2525, 3.1651, 7.525, 13.6881, 1.6837, 6.8192, 12.7603, 13.5778, 6.6872, 12.9922, 13.6398, 4.0094, 3.9774, 4.2517, 10.3452, 1.9144, 0.49]
t_layer_7 = [2.0072, 10.9927, 2.4602, 5.4474, 9.7849, 1.2752, 5.1762, 9.6313, 10.4171, 5.145, 9.9564, 10.318, 3.1843, 3.1274, 3.3387, 8.9548, 1.6854, 0.4337]
t_layer_11 = [2.0604, 10.2743, 2.1821, 4.9812, 8.8391, 1.2245, 4.6323, 8.4832, 9.0457, 4.514, 8.7734, 9.1986, 2.9266, 2.8591, 3.0575, 9.0887, 1.7197, 0.45]

t_layer_1 = [0.0215, 0.2007, 0.0384, 0.0967, 0.1863, 0.0205, 0.0935, 0.1906, 0.2039, 0.0961, 0.1906, 0.1929, 0.051, 0.0502, 0.0529, 0.1247, 0.0201, 0.0049]
t_layer_3 = [0.0442, 0.2417, 0.0467, 0.112, 0.2146, 0.025, 0.1072, 0.201, 0.2119, 0.1023, 0.2008, 0.2097, 0.058, 0.0576, 0.061, 0.1573, 0.0272, 0.0068]
t_layer_5 = [0.038, 0.244, 0.0506, 0.1204, 0.219, 0.0269, 0.1091, 0.2042, 0.2172, 0.107, 0.2079, 0.2182, 0.0642, 0.0636, 0.068, 0.1655, 0.0306, 0.0078]
t_layer_7 = [0.045, 0.2462, 0.0551, 0.122, 0.2192, 0.0286, 0.1159, 0.2157, 0.2333, 0.1152, 0.223, 0.2311, 0.0713, 0.0701, 0.0748, 0.2006, 0.0378, 0.0097]

vgg_cx = [0.0372, 0.2332, 0.0477, 0.1128, 0.2098, 0.0252, 0.1064, 0.2029, 0.2166, 0.1052, 0.2056, 0.213, 0.0611, 0.0604, 0.0642, 0.162, 0.0289, 0.0073]
"""
# alex

t_layer_1 = [2.6997, 1.5771, 7.1388, 1.1526, 4.1399, 5.4937, 4.4701, 13.3427, 5.9307, 1.499]
t_layer_2 = [1.5539, 0.9657, 3.851, 0.737, 2.3149, 3.0134, 2.5832, 7.4599, 3.35, 0.8641]
t_layer_3 = [1.1248, 0.7235, 2.6335, 0.5731, 1.6335, 2.0954, 1.8695, 5.1508, 2.3241, 0.6139]
t_layer_5 = [0.8235, 0.532, 1.7553, 0.3779, 1.1855, 1.4294, 1.3552, 3.8193, 1.7244, 0.4637]
t_layer_7 = [0.742, 0.4258, 1.4703, 0.3053, 1.0193, 1.2244, 1.1824, 3.4795, 1.5702, 0.4356]

print(sum(t_layer_5))

"""
t_layer_1 = [0.0086, 0.005, 0.0228, 0.0037, 0.0132, 0.0176, 0.0143, 0.0427, 0.019, 0.0048]
t_layer_2 = [0.0099, 0.0062, 0.0246, 0.0047, 0.0148, 0.0193, 0.0165, 0.0477, 0.0214, 0.0055]
t_layer_3 = [0.0108, 0.0069, 0.0253, 0.0055, 0.0157, 0.0201, 0.0179, 0.0494, 0.0223, 0.0059]
t_layer_5 = [0.0132, 0.0085, 0.0281, 0.006, 0.019, 0.0229, 0.0217, 0.0611, 0.0276, 0.0074]
"""
alexnet_cx = [0.0106, 0.0066, 0.0252, 0.005, 0.0157, 0.02, 0.0176, 0.0502, 0.0226, 0.0059]

print(1000 * sum(alexnet_cx)/ (5 * 3.2))

t = []
params = []
for i in range(len(t_layer_1)):
    t.append(round(np.average([t_layer_1[i], t_layer_2[i], t_layer_3[i], t_layer_5[i]]), 4))

print(t)

cx = []
for i in range(len(t_layer_5)):
    t_layer_5[i] = round(t_layer_5[i] * 5 * 3.2 / 1000, 4)

print("t_layer_5=", t_layer_5)


"""
t = []
params = []
for i in range(len(t_layer_1)):
    t.append([t_layer_1[i], t_layer_2[i], t_layer_3[i], t_layer_5[i], t_layer_7[i]])
    print(t[-1])
    a, b, c = fit(t[-1], x=[1, 2, 3, 5, 7])
    params.append([a, b, c])

print(params)

with open("parameter.json", "r") as jsonFile:
    params = json.load(jsonFile)["RestNet"]

t = []
for cpu in [1, 2, 3, 5, 7]:
    s = 0
    for i in range(len(t_layer_1)):
        a, b, c = params[i][0], params[i][1], params[i][2]
        s += func(cpu, a, b, c)
    t.append(round(s, 1))
print(t)
"""


